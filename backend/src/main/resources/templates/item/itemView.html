<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <meta name="description" content=""/>
    <meta name="author" content=""/>
    <title>PKLshop</title>
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico"/>
    <!-- Bootstrap icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet"/>
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="/css/styles.css" rel="stylesheet"/>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>


<script th:inline="javascript">
    /*<![CDATA[*/
    var currentMemberId = /*[[${currentMemberId}]]*/ null;
    var itemId = /*[[${item.itemId}]]*/ null;

    // 1. 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
        // 수량 입력 필드 초기화
        const orderCountInput = document.getElementById('orderCount');
        if (orderCountInput) {
            orderCountInput.addEventListener('change', calculateTotalPrice);
        calculateTotalPrice();
        }

        // 썸네일 이미지 초기화
        const thumbnailItems = document.querySelectorAll('.thumbnail-item');
        thumbnailItems.forEach(item => {
            item.addEventListener('click', function() {
                const slideIndex = this.getAttribute('data-slide-index');
                if (slideIndex) {
                    const carousel = new bootstrap.Carousel(document.getElementById('productImageSlider'));
                    carousel.to(parseInt(slideIndex));
                }
        });
    });

        // 리뷰 로드
                loadReviews();
    });

    // 2. 상품 관련 함수들
    function calculateTotalPrice() {
        const orderCountInput = document.getElementById('orderCount');
        const totalPriceElement = document.getElementById('totalPrice');
        
        if (!orderCountInput || !totalPriceElement) return;
        
        const quantity = parseInt(orderCountInput.value) || 1;
        const price = [[${item.price}]];
        const totalPrice = quantity * price;
        
        totalPriceElement.textContent = totalPrice.toLocaleString() + ' KRW';
    }

    function addCart() {
        const itemId = parseInt($("#orderItemId").val());
        const cartForm = {
            itemId: itemId,
            count: 1
        };

        // 먼저 장바구니에 이미 있는지 확인
        $.ajax({
            url: `/cart/check/${itemId}`,
            type: 'GET',
            success: function(exists) {
                if (exists) {
                    alert("This item is already in your cart.");
                    return;
                }
                
                // 장바구니에 없으면 추가
        $.ajax({
            url: "/cart",
                    data: JSON.stringify(cartForm),
            type: 'POST',
                    contentType: 'application/json',
            success: function (response) {
                alert("Item added to cart.");
                $(".badge.bg-dark.text-white.ms-1.rounded-pill").text(response.count);
            },
            error: function (jqXHR) {
                if (jqXHR.status === 401) {
                    alert("Login is required.");
                    location.href = "/members";
                } else {
                    alert(jqXHR.responseText);
                        }
                    }
                });
            },
            error: function(jqXHR) {
                if (jqXHR.status === 401) {
                    alert("Login is required.");
                    location.href = "/members";
                } else {
                    alert("Failed to check cart.");
                }
            }
        });
    }

    function initiateCheckout() {
        // 로그인 체크
        const currentMemberId = [[${currentMemberId}]];
        if (!currentMemberId) {
            alert("Login is required.");
            window.location.href = "/members";
            return;
        }

        const count = document.getElementById('orderCount').value;
        const stockQuantity = [[${item.stockQuantity}]];
        
        if (count > stockQuantity) {
            alert("Out of stock. Current inventory: " + stockQuantity + " units");
            return;
        }

        const checkoutData = {
            itemId: [[${item.itemId}]],
            count: parseInt(count),
            price: [[${item.price}]],
            itemName: [[${item.name}]]
        };

        // Stripe 결제 세션 생성 요청
        fetch('/api/checkout/create-checkout-session-single', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(checkoutData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Payment processing failed.');
            }
            return response.json();
        })
            .then(data => {
            // Stripe 객체 초기화 및 결제 페이지로 리디렉션
            const stripe = Stripe([[${stripePublicKey}]]);
            return stripe.redirectToCheckout({ sessionId: data.sessionId });
        })
        .catch(error => {
            console.error('Error:', error);
            alert(error.message || 'Payment processing failed.');
        });
    }

    // 3. 수정 모드 관련 함수들
    function toggleEditMode() {
        const viewElements = document.querySelectorAll('.view-mode');
        const editElements = document.querySelectorAll('.edit-mode');

        viewElements.forEach(el => {
            el.classList.toggle('hidden');
        });

        editElements.forEach(el => {
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        });
    }

    // 4. 리뷰 관련 함수들
    function loadReviews() {
        // URL에서 itemId 추출
        const pathArray = window.location.pathname.split('/');
        const itemId = pathArray[pathArray.length - 1];
        
        fetch(`/api/items/${itemId}/reviews`)
            .then(response => response.json())
            .then(reviews => {
                const reviewsList = document.getElementById('reviewsList');
                reviewsList.innerHTML = reviews.map(review => `
                    <div class="card mb-3" id="review-${review.reviewId}">
                        <div class="card-body">
                            <div class="mb-2">
                                <h6 class="card-subtitle text-muted">
                                    ${review.memberName || 'Anonymous'} • 
                                    ${new Date(review.createdDate).toLocaleDateString()}
                                </h6>
                                <div class="text-warning">
                                    ${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}
                                </div>
                            </div>
                            <p class="card-text">${review.content}</p>
                            ${review.reviewImages && review.reviewImages.length > 0 ? `
                                <div class="review-images d-flex flex-wrap gap-2 mt-2 mb-3">
                                    ${review.reviewImages.map(img => `
                                        <div class="review-image-container" style="width: 150px; height: 150px; overflow: hidden; border-radius: 4px; border: 1px solid #dee2e6;">
                                            <img src="${img.imageUrl}" alt="Review image" 
                                                style="width: 100%; height: 100%; object-fit: contain;">
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${review.owner ? `
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-dark rounded-pill" onclick="editReview(${review.reviewId})">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-outline-danger rounded-pill" onclick="deleteReview(${review.reviewId})">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            })
            .catch(error => {
                console.error('Error loading reviews:', error);
            });
    }

    function editReview(reviewId) {
        fetch(`/api/reviews/${reviewId}`)
            .then(response => response.json())
            .then(review => {
                const reviewCard = document.querySelector(`#review-${reviewId}`);
                reviewCard.innerHTML = `
                    <div class="card-body">
                        <form id="edit-form-${reviewId}" onsubmit="event.preventDefault(); updateReview(${reviewId})">
                            <div class="mb-3">
                                <label class="form-label">Rating</label>
                                <div class="rating">
                                    <input type="radio" name="rating" value="5" id="edit-5-${reviewId}" ${review.rating === 5 ? 'checked' : ''}>
                                    <label for="edit-5-${reviewId}">☆</label>
                                    <input type="radio" name="rating" value="4" id="edit-4-${reviewId}" ${review.rating === 4 ? 'checked' : ''}>
                                    <label for="edit-4-${reviewId}">☆</label>
                                    <input type="radio" name="rating" value="3" id="edit-3-${reviewId}" ${review.rating === 3 ? 'checked' : ''}>
                                    <label for="edit-3-${reviewId}">☆</label>
                                    <input type="radio" name="rating" value="2" id="edit-2-${reviewId}" ${review.rating === 2 ? 'checked' : ''}>
                                    <label for="edit-2-${reviewId}">☆</label>
                                    <input type="radio" name="rating" value="1" id="edit-1-${reviewId}" ${review.rating === 1 ? 'checked' : ''}>
                                    <label for="edit-1-${reviewId}">☆</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Review</label>
                                <textarea class="form-control" name="content" rows="3" required>${review.content}</textarea>
                            </div>
                            ${review.reviewImages && review.reviewImages.length > 0 ? `
                                <div class="mb-3">
                                    <label class="form-label">Current Images</label>
                                    <div class="review-images d-flex flex-wrap gap-2 mb-3">
                                        ${review.reviewImages.map(img => `
                                            <div class="review-image-container" style="width: 100px; height: 100px; overflow: hidden; border-radius: 4px; border: 1px solid #dee2e6;">
                                                <img src="${img.imageUrl}" alt="Review image" 
                                                    style="width: 100%; height: 100%; object-fit: contain;">
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div class="mb-3">
                                <label class="form-label">Add New Images</label>
                                <input type="file" class="form-control" name="reviewImages" multiple accept="image/*" onchange="previewReviewImages(this)">
                                <div class="review-image-preview mt-2 d-flex gap-2"></div>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                <button type="button" class="btn btn-secondary" onclick="loadReviews()">Cancel</button>
                            </div>
                        </form>
                    </div>
                `;
            });
    }

    function updateReview(reviewId) {
        const form = document.getElementById(`edit-form-${reviewId}`);
        const formData = new FormData(form);
        
        fetch(`/api/reviews/${reviewId}`, {
            method: 'PUT',
            body: formData
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to update review');
            return response.json();
        })
        .then(data => {
            alert('Review has been updated.');
            loadReviews();
            // 평점 업데이트
            const itemId = document.querySelector('input[name="itemId"]').value;
            updateItemRating(itemId);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update review.');
        });
    }

    function deleteReview(reviewId) {
        if (!confirm('Are you sure you want to delete this review?')) return;
        
        fetch(`/api/reviews/${reviewId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to delete review');
            // 응답이 비어있어도 삭제 처리 진행
            loadReviews();
            // URL에서 itemId 추출
            const pathArray = window.location.pathname.split('/');
            const itemId = pathArray[pathArray.length - 1];
            updateItemRating(itemId);
            alert('Review has been deleted.');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete review.');
        });
    }

    function updateAverageRating(averageRating, reviewCount) {
        const stars = '★'.repeat(Math.floor(averageRating)) + '☆'.repeat(5 - Math.floor(averageRating));
        $('.star-rating').first().text(stars);
        $('.text-muted').first().text(`(${averageRating.toFixed(1)}) (${reviewCount} reviews)`);
    }

    function updateItemRating(itemId) {
        fetch(`/api/items/${itemId}/rating`)
            .then(response => response.json())
            .then(data => {
                // 상품 상세 페이지의 평점 표시 업데이트
                const starRating = '★'.repeat(Math.round(data.averageRating)) + '☆'.repeat(5 - Math.round(data.averageRating));
                document.querySelector('.star-rating').textContent = starRating;
                document.querySelector('.text-muted').textContent = 
                    `(${data.averageRating.toFixed(1)}) (${data.reviewCount} reviews)`;
                
                // 평점이 0인 경우 (리뷰가 없는 경우) 처리
                if (data.reviewCount === 0) {
                    document.querySelector('.star-rating').textContent = '☆☆☆☆☆';
                    document.querySelector('.text-muted').textContent = '(0.0) (0 reviews)';
                }
            })
            .catch(error => console.error('Error updating rating:', error));
    }

    function previewImages(input) {
        const previewContainer = input.nextElementSibling;
        previewContainer.innerHTML = '';
        
        if (input.files) {
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '200px';
                    img.style.height = '200px';
                    img.style.objectFit = 'contain';
                    img.className = 'img-thumbnail';
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }
    }

    // 리뷰 작성 폼 부분
    function previewReviewImages(input) {
        const previewContainer = input.nextElementSibling;
        previewContainer.innerHTML = '';
        
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '100px';
                img.style.height = '100px';
                img.style.objectFit = 'contain';
                img.className = 'rounded border';
                previewContainer.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    }

    // 리뷰 제출
    function submitReview() {
        const form = document.getElementById('reviewForm');
        const formData = new FormData(form);
        const itemId = document.querySelector('input[name="itemId"]').value;
        
        fetch(`/api/items/${itemId}/reviews`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(response.statusText);
            }
            return response.json();
        })
        .then(data => {
            alert('Review has been registered.');
            loadReviews();
            form.reset();
            document.querySelector('.review-image-preview').innerHTML = '';
            
            // 평균 평점 업데이트
            updateItemRating(itemId);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('already written a review.');
        });
    }

    // 리뷰 수정 시 이미지 미리보기
    function previewEditImages(input) {
        const previewContainer = input.nextElementSibling;  // input 바로 다음의 미리보기 컨테이너 사용
        previewContainer.innerHTML = '';
        
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '200px';
                img.style.height = '200px';
                img.style.objectFit = 'contain';
                img.className = 'rounded border';
                previewContainer.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    }

    // 평균 평점 업데이트 함수 추가
    function updateItemRating(itemId) {
        fetch(`/api/items/${itemId}/rating`)
            .then(response => response.json())
            .then(data => {
                // 상품 상세 페이지의 평점 표시 업데이트
                const starRating = '★'.repeat(Math.round(data.averageRating)) + '☆'.repeat(5 - Math.round(data.averageRating));
                document.querySelector('.star-rating').textContent = starRating;
                document.querySelector('.text-muted').textContent = 
                    `(${data.averageRating.toFixed(1)}) (${data.reviewCount} reviews)`;
                
                // 평점이 0인 경우 (리뷰가 없는 경우) 처리
                if (data.reviewCount === 0) {
                    document.querySelector('.star-rating').textContent = '☆☆☆☆☆';
                    document.querySelector('.text-muted').textContent = '(0.0) (0 reviews)';
                }
            })
            .catch(error => console.error('Error updating rating:', error));
    }

    // 상품 삭제 함수 수정
    function deleteItem() {
        if (!confirm('Are you sure you want to delete this item?')) return;
        
        // URL에서 itemId 추출
        const pathArray = window.location.pathname.split('/');
        const itemId = pathArray[pathArray.length - 1];
        
        fetch(`/api/items/${itemId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to delete item');
            return response.json();
        })
        .then(data => {
            alert('Item has been deleted.');
            window.location.href = '/';  // 홈페이지로 리다이렉트
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete item.');
        });
    }
    /*]]>*/
</script>

<body>
<!-- Navigation-->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container px-4 px-lg-5">
        <a class="navbar-brand fw-bold" th:href="@{/}">PKLshop</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
            </ul>
            <div class="d-flex gap-2">
                <!-- 로그인하지 않은 경우 -->
                <div th:unless="${currentMemberId != null}" class="d-flex gap-2">
                    <form th:action="@{/members}">
                        <button class="btn btn-outline-dark px-4 rounded-pill nav-btn">
                            Login
                        </button>
                    </form>
                    <form th:action="@{/members/new}">
                        <button class="btn btn-dark px-4 rounded-pill nav-btn">
                            Sign Up
                        </button>
                    </form>
                </div>
                <!-- 로그인한 경우 -->
                <div th:if="${currentMemberId != null}" class="d-flex gap-2">
                    <form th:action="@{/cart}">
                        <button class="btn btn-outline-dark rounded-pill nav-btn">
                    <i class="bi-cart-fill me-1"></i>
                    Cart
                    <span class="badge bg-dark text-white ms-1 rounded-pill" th:text="${cartItemCount}">0</span>
                </button>
            </form>
                    <form th:action="@{/orders}">
                        <button class="btn btn-outline-dark rounded-pill nav-btn">Orders</button>
                    </form>
                    <form th:action="@{/logout}" method="post">
                        <button class="btn btn-dark rounded-pill nav-btn">Logout</button>
            </form>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- 스타일 추가 -->
<style>
    .nav-btn {
        transition: all 0.2s;
    }
    
    .nav-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .navbar {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
</style>

<!-- Product section -->
<section class="py-5">
    <div class="container px-4 px-lg-5 my-5" th:object="${item}">
        <div class="row gx-4 gx-lg-5 align-items-start">
            <!-- 왼쪽 이미지 영역 - 메인 뷰와 수정 모드에서 공유 -->
            <div class="col-md-6">
                <div class="image-container">
                <!-- 메인 이미지 슬라이더 -->
                    <div id="productImageSlider" class="carousel slide mb-3">
                    <div class="carousel-inner">
                        <!-- 이미지가 없을 경우 기본 이미지 표시 -->
                        <div th:if="${item.getItemImageListDto().isEmpty()}" class="carousel-item active">
                            <img src="/images/default-image.jpg" class="d-block w-100"
                                     style="width: 100%; height: 400px; object-fit: contain; background-color: #f8f9fa;" alt="Default Image">
                        </div>
                        <!-- 이미지 리스트 순회 -->
                        <div th:each="image, iterStat : ${item.getItemImageListDto()}"
                             th:class="${iterStat.first} ? 'carousel-item active' : 'carousel-item'">
                                <img th:src="${image.getImageUrl()}" 
                                     class="d-block w-100"
                                     style="width: 100%; height: 400px; object-fit: contain; background-color: #f8f9fa;"
                                 th:alt="${item.getName()}">
                        </div>
                    </div>
                    <!-- 이미지가 2개 이상일 때만 컨트롤 버튼 표시 -->
                    <th:block th:if="${item.getItemImageListDto().size() > 1}">
                        <button class="carousel-control-prev" type="button" data-bs-target="#productImageSlider" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#productImageSlider" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </th:block>
                </div>

                    <!-- 썸네일 미리보기 -->
                    <div class="thumbnail-preview" th:if="${!item.getItemImageListDto().isEmpty()}">
                        <div class="d-flex flex-wrap gap-2 justify-content-center">
                        <div th:each="image, iterStat : ${item.getItemImageListDto()}"
                             class="thumbnail-item"
                             th:data-slide-index="${iterStat.index}">
                                <img th:src="${image.getImageUrl()}"
                                 th:class="${iterStat.first} ? 'active' : ''"
                                 style="width: 60px; height: 60px; object-fit: contain; cursor: pointer;"
                                 th:alt="${item.getName()}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 오른쪽 영역 - 상품 정보/수정 폼 -->
            <div class="col-md-6">
                <!-- 메인 뷰 모드 -->
                <div class="view-mode">
                    <h1 class="h3 fw-bold" th:text="${item.getName()}">Shop item template</h1>
                    <div class="mb-3">
                        <span class="star-rating" th:text="${'★'.repeat(item.getAverageRating().intValue()) + '☆'.repeat(5 - item.getAverageRating().intValue())}"></span>
                        <span class="text-muted" th:text="'(' + ${#numbers.formatDecimal(item.getAverageRating(), 1, 1)} + ') (' + ${item.getReviewCount()} + ' reviews)'"></span>
                    </div>
                    
                    <div class="fs-4 fw-bold mb-3">
                    <input type="hidden" th:value="${item.itemId}" id="orderItemId" name="orderItemId">
                        <input type="hidden" th:value="${item.price}" id="orderPrice" name="orderPrice">
                        <input type="hidden" th:value="${item.stockQuantity}" id="orderStockQuantity" name="orderStockQuantity">
                        <span th:text="${#numbers.formatInteger(item.price, 0, 'COMMA')}"></span> KRW
                    </div>

                    <!-- 수량과 재고 부분 수정 -->
                    <div class="mb-3 d-flex align-items-center gap-3">
                        <div class="input-group" style="width: 200px;">
                            <span class="input-group-text">Quantity</span>
                            <input class="form-control text-center" id="orderCount" name="orderCount" type="number"
                                   value="1" min="1" th:max="${item.stockQuantity}" onchange="calculateTotalPrice()"/>
                        </div>
                        <div class="input-group" style="width: 200px;">
                            <span class="input-group-text">Stock</span>
                            <input class="form-control text-center" type="text" 
                                   th:value="${#numbers.formatInteger(item.stockQuantity, 0, 'COMMA')}" 
                                   readonly style="background-color: #f8f9fa;"/>
                    </div>
                    </div>
                    
                    <div class="bg-light p-3 rounded mb-3">
                        <div class="fw-bold mb-1">Total Price</div>
                        <div class="fs-4 fw-bold" id="totalPrice" th:text="${#numbers.formatInteger(item.price, 0, 'COMMA')} + ' KRW'"></div>
                </div>

                    <!-- 버튼 그룹 수정 -->
                    <div class="d-flex gap-2">
                        <button class="btn btn-dark" type="button" onclick="initiateCheckout()">
                            <i class="bi-bag-check-fill me-1"></i>
                            Buy Now
                        </button>
                        <button class="btn btn-outline-dark" type="button" th:onclick="addCart()">
                            <i class="bi-cart-fill me-1"></i>
                            Add to Cart
                        </button>
                        <!-- 수정/삭제 버튼은 로그인한 사용자의 상품일 때만 표시 -->
                        <div th:if="${currentMemberId != null && currentMemberId == item.memberId}" class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-dark" onclick="toggleEditMode()">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="deleteItem()">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 수정 모드 -->
                <div class="edit-mode" style="display: none;">
                    <form th:action="@{/items/{itemId}/edit(itemId=${item.itemId})}" method="post" enctype="multipart/form-data">
                        <!-- 기본 정보 필드들 -->
                    <div class="mb-3">
                            <label class="form-label">Product Name</label>
                            <input type="text" class="form-control" name="name" th:value="${item.name}" required>
                    </div>
                        
                    <div class="mb-3">
                            <label class="form-label">Price</label>
                            <input type="number" class="form-control" name="price" th:value="${item.price}" required>
                    </div>
                        
                    <div class="mb-3">
                            <label class="form-label">Stock Quantity</label>
                            <input type="number" class="form-control" name="stockQuantity" th:value="${item.stockQuantity}" required>
                    </div>
                        
                    <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" name="category" required>
                                <option value="APPAREL" th:selected="${item.category.name() == 'APPAREL'}">Apparel</option>
                                <option value="ELECTRONICS" th:selected="${item.category.name() == 'ELECTRONICS'}">Electronics</option>
                                <option value="BOOKS" th:selected="${item.category.name() == 'BOOKS'}">Books</option>
                                <option value="HOME_AND_KITCHEN" th:selected="${item.category.name() == 'HOME_AND_KITCHEN'}">Home & Kitchen</option>
                                <option value="HEALTH_AND_BEAUTY" th:selected="${item.category.name() == 'HEALTH_AND_BEAUTY'}">Health & Beauty</option>
                        </select>
                    </div>
                        
                    <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="5" required th:text="${item.description}"></textarea>
                    </div>

                        <!-- 새 이미지 업로드 -->
                    <div class="mb-3">
                            <label class="form-label">Add New Images</label>
                            <input type="file" class="form-control" name="itemImages" multiple accept="image/*" onchange="previewImages(this)">
                        <div class="preview-images mt-2 d-flex flex-wrap gap-2"></div>
                    </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="toggleEditMode()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Product Description and Original Image Section -->
<section class="py-5 bg-light view-mode">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <!-- Original Size Image -->
                <div class="mb-4">
                    <h4 class="mb-3">Product Detail Images</h4>
                    <div th:each="image : ${item.itemImageListDto}" class="mb-3">
                        <img th:src="${image.getImageUrl()}"
                             class="img-fluid"
                             style="width: 100%; height: 500px; object-fit: contain; background-color: #f8f9fa;"
                             th:alt="${item.name}">
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <!-- Product Description -->
                <div class="mb-4">
                    <h4 class="mb-3">Product Description</h4>
                    <p class="lead" style="white-space: pre-line;" th:text="${item.description}"></p>
                </div>
            </div>
        </div>
    </div>
    <hr class="my-4">
</section>

<!-- Reviews Section -->
<div class="container px-4 px-lg-5 my-5 view-mode">
    <h3 class="mb-4">Reviews</h3>

    <!-- Review Form - 로그인했고, 자신의 상품이 아닌 경우에만 표시 -->
    <div class="card mb-4" th:if="${currentMemberId != null && currentMemberId != item.memberId}">
        <div class="card-body">
            <h5 class="card-title">Write a Review</h5>
            <form id="reviewForm" enctype="multipart/form-data">
                <input type="hidden" name="itemId" th:value="${item.itemId}">
                <div class="mb-3">
                    <label class="form-label">Rating</label>
                    <div class="rating">
                        <input type="radio" name="rating" value="5" id="5" required><label for="5">☆</label>
                        <input type="radio" name="rating" value="4" id="4"><label for="4">☆</label>
                        <input type="radio" name="rating" value="3" id="3"><label for="3">☆</label>
                        <input type="radio" name="rating" value="2" id="2"><label for="2">☆</label>
                        <input type="radio" name="rating" value="1" id="1"><label for="1">☆</label>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Review</label>
                    <textarea class="form-control" name="content" rows="3" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Images</label>
                    <input type="file" class="form-control" name="reviewImages" multiple accept="image/*" onchange="previewReviewImages(this)">
                    <div class="review-image-preview mt-2 d-flex gap-2"></div>
                </div>
                <button type="button" class="btn btn-primary" onclick="submitReview()">Submit Review</button>
            </form>
        </div>
    </div>

    <!-- 로그인하지 않은 경우 리뷰 작성 안내 -->
    <div class="alert alert-warning mb-4" th:if="${currentMemberId == null}">
        Please <a href="/members">log in</a> to write a review.
    </div>

    <!-- 자신의 상품인 경우 리뷰 작성 불가 메시지 -->
    <div class="alert alert-info mb-4" th:if="${currentMemberId != null && currentMemberId == item.memberId}">
        You cannot write a review for your own product.
    </div>

    <!-- Reviews List - 항상 표시 -->
    <div id="reviewsList">
        <!-- Reviews will be loaded here -->
    </div>
</div>

<!-- Footer-->
<footer class="py-5 bg-dark">
    <div class="container">
        <p class="m-0 text-center text-white">Copyright &copy; PKLshop</p>
    </div>
</footer>
<!-- Bootstrap core JS-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Core theme JS-->
<!--<script src="js/scripts.js"></script>-->

<style>
    :root {
        --primary-color: #212529;
        --secondary-color: #495057;
        --background-color: #f8f9fa;
        --border-color: #dee2e6;
        --star-color: #ffd700;
        --white: #ffffff;
        --danger: #dc3545;
    }

    .preview-images {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 20px;
    }

    .preview-images img {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
        width: 200px;
        height: 200px;
        object-fit: contain;
    }

    .rating {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
    }

    .rating > input {
        display: none;
    }

    .rating > label {
        position: relative;
        width: 1.1em;
        font-size: 2em;
        color: var(--star-color);
        cursor: pointer;
    }

    .rating > label::before {
        content: "★";
        position: absolute;
        opacity: 0;
    }

    .rating > label:hover:before,
    .rating > label:hover ~ label:before {
        opacity: 1 !important;
    }

    .rating > input:checked ~ label:before {
        opacity: 1;
    }

    .review-item {
        border-bottom: 1px solid var(--border-color);
        padding: 1rem 0;
    }

    .review-item:last-child {
        border-bottom: none;
    }

    .star-rating {
        color: var(--star-color);
    }

    /* 이미지 슬라이더 컨트롤 스타일 수정 */
    .carousel-control-prev,
    .carousel-control-next {
        background-color: rgba(0, 0, 0, 0.5);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: all 0.2s ease;
    }

    /* 슬라이더에 마우스를 올렸을 때만 컨트롤 표시 */
    #productImageSlider:hover .carousel-control-prev,
    #productImageSlider:hover .carousel-control-next {
        opacity: 0.7;
        visibility: visible;
        pointer-events: auto;
    }

    .carousel-control-prev:hover,
    .carousel-control-next:hover {
        background-color: rgba(0, 0, 0, 0.7);
        opacity: 1 !important;
        transform: translateY(-50%) scale(1.1);
    }

    /* 화살표 아이콘 크기 조정 */
    .carousel-control-prev-icon,
    .carousel-control-next-icon {
        width: 25px;
        height: 25px;
    }

    /* 기본 스타일 재정의 */
    .form-control:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 0.2rem rgba(33, 37, 41, 0.15);
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn-primary:hover {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
    }

    .btn-outline-dark {
        color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn-outline-dark:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: var(--white);
    }

    .navbar-dark {
        background-color: var(--primary-color) !important;
    }

    .bg-dark {
        background-color: var(--primary-color) !important;
    }

    .card {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }

    /* 썸네일 스타일 수정 */
    .thumbnail-preview {
        margin-top: 1rem;
        padding: 0.5rem;
        background-color: var(--background-color);
        border-radius: 4px;
    }

    .thumbnail-item {
        margin: 0.25rem;
    }

    .thumbnail-item img {
        width: 50px;
        height: 50px;
        object-fit: contain;
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 4px;
        padding: 2px;
    }

    .thumbnail-item img:hover {
        border-color: var(--secondary-color);
    }

    .thumbnail-item img.active {
        border-color: var(--primary-color);
    }

    /* 상품 정보 컨테이너 */
    .product-info {
        padding-left: 1.5rem;
    }

    /* 버튼 그룹 */
    .d-flex.gap-2 {
        flex-wrap: nowrap;
    }

    .d-flex.gap-2 form {
        margin: 0;
    }

    /* 버튼 스타일 */
    .btn-danger {
        background-color: var(--danger);
        border-color: var(--danger);
    }

    .btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }

    .btn-secondary {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
    }

    .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #545b62;
    }

    /* 수량과 재고 입력 그룹 스타일 */
    .input-group {
        border: 1px solid var(--border-color);
        border-radius: 4px;
        overflow: hidden;
    }

    .input-group-text {
        background-color: var(--background-color);
        border: none;
        color: var(--secondary-color);
        font-weight: 500;
        min-width: 80px;  /* 레이블 너비 통일 */
    }

    .input-group .form-control {
        border: none;
        text-align: center;
        padding: 0.5rem;
    }

    .input-group .form-control:focus {
        box-shadow: none;
    }

    .input-group .form-control[readonly] {
        background-color: #f8f9fa;
        color: var(--danger);
        font-weight: 500;
    }

    .product-image {
        transition: transform 0.2s;
    }

    .product-image:hover {
        transform: scale(1.02);
    }

    .thumbnail-preview img {
        transition: transform 0.2s;
        cursor: pointer;
    }

    .thumbnail-preview img:hover {
        transform: scale(1.05);
    }

    .thumbnail-preview img.active {
        border: 2px solid var(--primary-color) !important;
    }

    .edit-mode {
        display: none;
    }

    /* toggleEditMode 함수가 호출될 때 view-mode 요소들을 숨김 */
    .view-mode.hidden {
        display: none !important;
    }

    /* 리뷰 이미지 관련 스타일 */
    .review-image-preview img, .edit-image-preview img {
        width: 100px;
        height: 100px;
        object-fit: contain;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 2px;
        background-color: #f8f9fa;
    }

    .review-images img {
        width: 200px;
        height: 200px;
        object-fit: contain;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 5px;
        background-color: #f8f9fa;
    }

    .review-image-preview img {
        width: 100px;
        height: 100px;
        object-fit: contain;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .rating {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
    }

    .rating > input {
        display: none;
    }

    .rating > label {
        position: relative;
        width: 1.1em;
        font-size: 2em;
        color: #ffd700;
        cursor: pointer;
    }

    .rating > label::before {
        content: "☆";
        position: absolute;
        opacity: 1;
    }

    .rating > input:checked ~ label:before {
        content: "★";
    }

    .rating > label:hover:before,
    .rating > label:hover ~ label:before {
        content: "★";
        opacity: 0.8;
    }
</style>
</body>
</html>