<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">

<head>

    <meta charset="utf-8"/>

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>

    <title>Product Management - PKLshop</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet"/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <link href="/css/styles.css" rel="stylesheet"/>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <style>
        :root {
            --primary-color: #212529;
            --secondary-color: #495057;
            --background-color: #f8f9fa;
            --border-color: #dee2e6;
            --white: #ffffff;
        }

        .card {
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            margin-bottom: 2rem;
        }

        .btn-outline-dark {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-dark:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--white);
        }

        .navbar-dark {
            background-color: var(--primary-color) !important;
        }

        .bg-dark {
            background-color: var(--primary-color) !important;
        }

        .table img {
            transition: transform 0.2s;
            width: 60px;
            height: 60px;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.25rem;
            background-color: var(--white);
            object-fit: contain;
        }

        .table img:hover {
            transform: scale(1.05);
            border-color: var(--primary-color);
        }

        .badge {
            padding: 0.5rem 0.75rem;
            font-weight: 500;
        }

        .badge.bg-success {
            background-color: #28a745 !important;
        }

        .badge.bg-warning {
            background-color: #ffc107 !important;
            color: #212529;
        }

        .badge.bg-danger {
            background-color: #dc3545 !important;
        }

        .table td, .table th {
            padding: 1rem;
            vertical-align: middle;
        }

        .form-select, .form-control {
            padding: 0.5rem 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
        }

        /* 상품명 링크 색상 수정 */
        .text-primary {
            color: var(--primary-color) !important;
        }

        /* 페이지네이션 스타일 수정 */
        .pagination {
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        
        .page-item {
            margin: 2px;
        }
        
        .page-link {
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 0.5rem;
            color: var(--primary-color);
            border-color: var(--border-color);
        }

        /* 페이지네이션 컨테이너 수정 */
        .pagination-container {
            overflow-x: auto;
            padding: 1rem 0;
        }
        
        /* 많은 페이지 번호를 처리하기 위한 스타일 */
        @media (max-width: 768px) {
            .pagination .page-item:not(.active):not(:first-child):not(:last-child) {
                display: none;
            }
            
            .pagination .page-item.active {
                display: block;
            }
        }

        /* 상품명 링크 스타일 수정 */
        .product-link {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.95rem;
            line-height: 1.2;
            margin-left: 0.5rem;
        }

        .product-link:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .img-fluid {
            max-width: 100%;
            height: auto;
            object-fit: cover;
        }

        .rounded {
            border-radius: 0.5rem !important;
        }

        /* 이미지 컨테이너 호버 효과 */
        .image-container {
            overflow: hidden;
            transition: transform 0.2s;
        }

        .image-container:hover {
            transform: scale(1.05);
        }

        /* 상품 이미지 관련 스타일 */
        .product-image-container {
            width: 80px;
            height: 80px;
            min-width: 80px;
            min-height: 80px;
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #dee2e6;
            margin-right: 0.5rem;
        }

        .image-wrapper, .no-image-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 4px;
            background-color: #f8f9fa;
        }

        .no-image-wrapper i {
            font-size: 1.5rem;
            color: #adb5bd;
        }

        /* 호버 효과 */
        .product-image-container:hover {
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .nav-btn {
            transition: all 0.2s;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* 권한없음 배지 스타일 */
        .permission-badge {
            display: inline-block;
            padding: 0.35rem 0.65rem;
            font-size: 0.75rem;
            font-weight: 500;
            line-height: 1;
            color: #6c757d;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .permission-badge i {
            margin-right: 0.25rem;
            font-size: 0.8rem;
        }
    </style>

</head>

<body class="bg-light">

<!-- Navigation-->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container px-4 px-lg-5">
        <a class="navbar-brand fw-bold" th:href="@{/}">PKLshop</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" 
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/items/manage}">Product Management</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/orders}">Order History</a>
                </li>
            </ul>
            <div class="d-flex align-items-center gap-3">
                <form th:action="@{/cart}">
                    <button class="btn btn-outline-dark rounded-pill nav-btn">
                        <i class="bi-cart-fill me-1"></i>
                        Cart
                        <span class="badge bg-dark text-white ms-1 rounded-pill" 
                              style="font-size: 0.7rem; padding: 0.25rem 0.5rem;" 
                              th:text="${cartItemCount}">0</span>
                    </button>
                </form>
                <form th:action="@{/orders}">
                    <button class="btn btn-outline-dark rounded-pill nav-btn">Orders</button>
                </form>
                <form th:action="@{/logout}" method="post">
                    <button class="btn btn-dark rounded-pill nav-btn">Logout</button>
                </form>
            </div>
        </div>
    </div>
</nav>



<div class="container mt-5">

    <h2 class="mb-4">Product Management</h2>



    <!-- 통계 카드 -->

    <div class="row mb-4">

        <div class="col-md-3">

            <div class="card bg-white">

                <div class="card-body">

                    <div class="d-flex align-items-center">

                        <i class="bi bi-box-seam fs-3 me-2"></i>

                        <div>

                            <h6 class="card-subtitle mb-1 text-muted">Total Products</h6>

                            <h3 class="card-title mb-0" th:text="${itemStats.totalCount}">0</h3>

                        </div>

                    </div>

                </div>

            </div>

        </div>

        <div class="col-md-3">

            <div class="card bg-white">

                <div class="card-body">

                    <div class="d-flex align-items-center">

                        <i class="bi bi-exclamation-triangle fs-3 me-2 text-warning"></i>

                        <div>

                            <h6 class="card-subtitle mb-1 text-muted">Low Stock</h6>

                            <h3 class="card-title mb-0" th:text="${itemStats.lowStockCount}">0</h3>

                        </div>

                    </div>

                </div>

            </div>

        </div>

        <div class="col-md-3">

            <div class="card bg-white">

                <div class="card-body">

                    <div class="d-flex align-items-center">

                        <i class="bi bi-check-circle fs-3 me-2 text-success"></i>

                        <div>

                            <h6 class="card-subtitle mb-1 text-muted">On Sale</h6>

                            <h3 class="card-title mb-0" th:text="${itemStats.onSaleCount}">0</h3>

                        </div>

                    </div>

                </div>

            </div>

        </div>

        <div class="col-md-3">

            <div class="card bg-white">

                <div class="card-body">

                    <div class="d-flex align-items-center">

                        <i class="bi bi-x-circle fs-3 me-2 text-danger"></i>

                        <div>

                            <h6 class="card-subtitle mb-1 text-muted">Discontinued</h6>

                            <h3 class="card-title mb-0" th:text="${itemStats.soldOutCount}">0</h3>

                        </div>

                    </div>

                </div>

            </div>

        </div>

    </div>



    <!-- 검색 및 필터 -->

    <div class="d-flex flex-wrap align-items-center gap-3 mb-4">

        <form th:action="@{/items/manage}" method="get" class="row g-3 flex-grow-1">

            <div class="col-md-4">

                <div class="input-group">

                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>

                    <input type="text" class="form-control" name="query" 

                           placeholder="Search by product name or code" th:value="${param.query}">

                </div>

            </div>

            <div class="col-md-2">

                <select class="form-select" name="category">

                    <option value="">All Categories</option>

                    <option th:each="category : ${T(com.dsapkl.backend.entity.Category).values()}"

                            th:value="${category}"

                            th:text="${category.name()}"

                            th:selected="${param.category == category.name()}">

                    </option>

                </select>

            </div>

            <div class="col-md-2">

                <select class="form-select" name="status">

                    <option value="">All Status</option>

                    <option value="SELLING" th:selected="${param.status == 'SELLING'}">On Sale</option>

                    <option value="SOLDOUT" th:selected="${param.status == 'SOLDOUT'}">Sold Out</option>

                    <option value="LOW_STOCK" th:selected="${param.status == 'LOW_STOCK'}">Low Stock</option>

                </select>

            </div>

            <div class="col-md-2">

                <button type="submit" class="btn btn-dark w-100">

                    <i class="bi bi-search"></i> Search

                </button>

            </div>

            <!-- 현재 페이지 크기와 정렬 상태 유지를 위한 hidden 필드들 -->

            <input type="hidden" name="page" value="0">

            <input type="hidden" name="size" th:value="${param.size}">

        </form>

        <div class="ms-3">

            <a th:href="@{/items/new}" class="btn btn-outline-dark">

                <i class="bi bi-plus-lg"></i> Add New Product

            </a>

        </div>

    </div>



    <!-- 제품 목록 -->

    <div class="card mb-4">

        <div class="card-body p-0">

            <div class="table-responsive">

                <table class="table table-hover mb-0">

                    <thead class="bg-light">

                    <tr>

                        <th class="border-0">Product Info</th>

                        <th class="border-0">Product Code</th>

                        <th class="border-0">Category</th>

                        <th class="border-0">Price</th>

                        <th class="border-0">Stock</th>

                        <th class="border-0">Status</th>

                        <th class="border-0">Last Modified</th>

                        <th class="border-0">Actions</th>

                    </tr>

                    </thead>

                    <tbody>

                    <tr th:each="item : ${items}">

                        <td>

                            <div class="d-flex align-items-center">
                                <div class="product-image-container">
                                    <div th:if="${item.getItemImageListDto() != null and !item.getItemImageListDto().isEmpty()}"
                                         class="image-wrapper">
                                        <img th:src="${item.getItemImageListDto().get(0).getImageUrl()}"
                                             alt="Product Image" 
                                             class="product-image">
                                    </div>
                                    <div th:if="${item.getItemImageListDto() == null or item.getItemImageListDto().isEmpty()}"
                                         class="no-image-wrapper">
                                        <i class="bi bi-image text-muted"></i>
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <a th:href="@{/items/{id}(id=${item.itemId})}" class="product-link">
                                        <p class="fw-bold mb-0" th:text="${item.name}">Product Name</p>
                                    </a>
                                </div>
                            </div>

                        </td>

                        <td th:text="${item.category.name() + '-' + item.itemId}">SNK-2024-001</td>

                        <td th:text="${item.category.name()}">Shoes</td>

                        <td th:text="${#numbers.formatInteger(item.price, 0, 'COMMA') + ' KRW'}">89,000 KRW</td>

                        <td th:text="${item.stockQuantity}">245</td>

                        <td>

                            <span th:if="${item.stockQuantity > 10}" class="badge bg-success">On Sale</span>

                            <span th:if="${item.stockQuantity <= 10 && item.stockQuantity > 0}" class="badge bg-warning">Low Stock</span>

                            <span th:if="${item.stockQuantity == 0}" class="badge bg-danger">Sold Out</span>

                        </td>

                        <td th:text="${item.modifiedDate != null ? 
                                      #temporals.format(item.modifiedDate, 'yyyy-MM-dd') : 
                                      #temporals.format(item.createdDate, 'yyyy-MM-dd')}">
                            2024-02-15
                        </td>

                        <td>
                            <div class="btn-group" th:if="${item.memberId == currentMemberId}">
                                <a th:href="@{/items/{itemId}/edit(itemId=${item.itemId})}" 
                                   class="btn btn-outline-dark btn-sm"
                                   th:onclick="return checkPermission([[${item.memberId}]], [[${currentMemberId}]], 'edit')">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button type="button" class="btn btn-outline-dark btn-sm" 
                                        th:onclick="checkPermissionAndDelete([[${item.memberId}]], [[${currentMemberId}]], [[${item.itemId}]])">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <span class="permission-badge" th:unless="${item.memberId == currentMemberId}">
                                <i class="bi bi-lock"></i>No Permission
                            </span>
                        </td>

                    </tr>

                    </tbody>

                </table>

            </div>

        </div>

    </div>



    <!-- 페이지네이션 -->

    <div class="d-flex justify-content-between align-items-center my-4">

        <div>

            <select class="form-select form-select-sm" style="width: 130px;" 

                    onchange="changePageSize(this.value)">

                <option value="10" th:selected="${param.size == null || param.size == 10}">10 per page</option>

                <option value="20" th:selected="${param.size == 20}">20 per page</option>

                <option value="50" th:selected="${param.size == 50}">50 per page</option>

            </select>

        </div>

        <div class="pagination-container">

            <nav th:if="${totalPages > 0}">

                <ul class="pagination mb-0">

                    <!-- 이전 그룹으로 이동 -->

                    <li class="page-item" th:classappend="${currentPage < 10 ? 'disabled' : ''}">

                        <a class="page-link" th:href="@{/items/manage(

                            page=${((currentPage/10)*10) - 1},

                            size=${param.size},

                            query=${param.query},

                            category=${param.category},

                            status=${param.status}

                        )}">

                            <i class="bi bi-chevron-double-left"></i>

                        </a>

                    </li>

                    <!-- 이전 페이지 -->

                    <li class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}">

                        <a class="page-link" th:href="@{/items/manage(

                            page=${currentPage - 1},

                            size=${param.size},

                            query=${param.query},

                            category=${param.category},

                            status=${param.status}

                        )}">

                            <i class="bi bi-chevron-left"></i>

                        </a>

                    </li>

                    <!-- 페이지 번호 -->

                    <li class="page-item" 

                        th:each="pageNum : ${#numbers.sequence(((currentPage/10)*10), ((currentPage/10)*10) + 9)}"

                        th:if="${pageNum < totalPages}"

                        th:classappend="${pageNum == currentPage ? 'active' : ''}">

                        <a class="page-link" 

                           th:href="@{/items/manage(

                               page=${pageNum},

                               size=${param.size},

                               query=${param.query},

                               category=${param.category},

                               status=${param.status}

                           )}"

                           th:text="${pageNum + 1}">1</a>

                    </li>

                    <!-- 다음 페이지 -->

                    <li class="page-item" th:classappend="${currentPage == totalPages - 1 ? 'disabled' : ''}">

                        <a class="page-link" th:href="@{/items/manage(

                            page=${currentPage + 1},

                            size=${param.size},

                            query=${param.query},

                            category=${param.category},

                            status=${param.status}

                        )}">

                            <i class="bi bi-chevron-right"></i>

                        </a>

                    </li>

                    <!-- 다음 그룹으로 이동 -->

                    <li class="page-item" 

                        th:classappend="${((currentPage/10)*10) + 10 >= totalPages ? 'disabled' : ''}">

                        <a class="page-link" th:href="@{/items/manage(

                            page=${((currentPage/10)*10) + 10},

                            size=${param.size},

                            query=${param.query},

                            category=${param.category},

                            status=${param.status}

                        )}">

                            <i class="bi bi-chevron-double-right"></i>

                        </a>

                    </li>

                </ul>

            </nav>

        </div>

    </div>

</div>

<div class="pb-5"></div>

<footer class="py-5 bg-dark">

    <div class="container">

        <p class="m-0 text-center text-white">Copyright &copy; PKLshop</p>

    </div>

</footer>



<script>

function checkPermission(itemMemberId, currentMemberId, action) {
    if (itemMemberId !== currentMemberId) {
        alert('You do not have permission to ' + action + ' this item.');
        return false;
    }
    return true;
}

function checkPermissionAndDelete(itemMemberId, currentMemberId, itemId) {
    if (!checkPermission(itemMemberId, currentMemberId, 'delete')) {
        return;
    }
    
    if (confirm('Are you sure you want to delete this product?')) {
        fetch(`/items/${itemId}/delete`, {
            method: 'POST'
        }).then(response => {
            if (response.ok) {
                alert('Product has been deleted.');
                location.reload();
            } else {
                alert('Failed to delete product.');
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the product.');
        });
    }
}

function changePageSize(size) {

    const url = new URL(window.location.href);

    url.searchParams.set('size', size);

    url.searchParams.set('page', '0');  // 페이지 크기가 변경되면 첫 페이지로 이동

    window.location.href = url.toString();

}

</script>



</body>

</html> 